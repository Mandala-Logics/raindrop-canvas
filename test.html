<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Raindrops</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
    }
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="mask-canvas" class="mask-layer"></canvas>
  <div class="blur-layer"></div>

  <script type="module">
    import { RaindropCanvas } from './raindrops.js';
    import { DropPolygon } from './raindrops.js'; // Only needed if referenced directly

    let context;
    let canvas;
    let dropTimer;
    let trailTimer;
    let sys;

    function ResizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      if (sys) sys.OnCanvasResize(canvas); // all the raindrop system to know how big the canvas is now, for removal of cells outside.
    }

    function DrawRaindrops(polygons) {
      context.fillStyle = 'black';
      context.fillRect(0, 0, canvas.width, canvas.height);

      context.globalCompositeOperation = 'destination-out';
      context.fillStyle = 'rgba(0, 0, 0, 1)';

      polygons.forEach(polygon => {
        polygon.FillSmooth(context);
      });

      context.globalCompositeOperation = 'source-over';
    }

    window.onload = () => {

      // Setup canvas and context
      canvas = document.getElementById("mask-canvas");
      context = canvas.getContext("2d");

      context.fillStyle = 'black';
      context.fillRect(0, 0, canvas.width, canvas.height);

      // Initialize system
      sys = new RaindropCanvas(DrawRaindrops);

      sys.ApplySettings({
        maxCellCount: 300,
        smoothLoopLimit: 2e3,
        canvasMargin : 20
      });

      // Create the color shift background layer
      const div = document.createElement("div");
      div.classList.add("color-shift-layer");
      document.body.appendChild(div);

      // Set canvas size and bind resize handler
      ResizeCanvas();
      window.addEventListener("resize", () => ResizeCanvas);

      context.fillStyle = 'black';
      context.rect(0, 0, canvas.width, canvas.height);

      // Start drop spawners
      dropTimer = window.setInterval(() => {
        sys.SpawnDrop(Math.random() * 10 + 10, Math.random() * canvas.width, Math.random() * canvas.height); 
      }, 1000);

      trailTimer = window.setInterval(() => {
        sys.ShedDrops();
      }, 500);

      // Start animation loop
      sys.Start();

    };
  </script>
</body>
</html>